name: CI

on:
  push:
    branches: [ main, develop, "*" ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read
  actions: read
  pull-requests: read

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Rust checks and tests
  rust-check:
    name: Rust ${{ matrix.rust }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        rust: [stable, nightly]
        exclude:
          # Skip nightly on Windows to save CI time
          - os: windows-latest
            rust: nightly
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: ${{ matrix.rust }}
        components: rustfmt, clippy
    
    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ matrix.rust }}-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-${{ matrix.rust }}-
          ${{ runner.os }}-cargo-
    
    - name: Install system dependencies (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y libgl1-mesa-dev libglu1-mesa-dev libxrandr-dev libxinerama-dev libxcursor-dev libxi-dev libxxf86vm-dev libasound2-dev
    
    - name: Check formatting
      if: matrix.rust == 'stable'
      run: cargo fmt --all -- --check
    
    - name: Run clippy
      if: matrix.rust == 'stable'
      run: cargo clippy --all-targets --all-features -- -D warnings
    
    - name: Build
      run: cargo build --verbose

    - name: Upload generated C# bindings
      if: matrix.rust == 'stable' && matrix.os == 'ubuntu-latest'
      uses: actions/upload-artifact@v4
      with:
        name: csharp-bindings
        path: sdks/GoudEngine/NativeMethods.g.cs
        retention-days: 1

    - name: Run tests
      run: cargo test --verbose -- --nocapture
    
    # Run Rust SDK tests specifically
    - name: Run Rust SDK tests
      if: matrix.rust == 'stable'
      run: cargo test --lib sdk --verbose -- --nocapture

    # Only run on stable for coverage
    - name: Install cargo-tarpaulin
      if: matrix.rust == 'stable' && matrix.os == 'ubuntu-latest'
      run: |
        cargo install cargo-tarpaulin || true
    
    - name: Generate coverage
      if: matrix.rust == 'stable' && matrix.os == 'ubuntu-latest'
      run: |
        cargo tarpaulin --out xml --all-features --workspace --timeout 300 --exclude-files "*/build.rs" --exclude-files "*/tests/*" --exclude-files "*/examples/*"
    
    - name: Upload coverage to Codecov
      if: matrix.rust == 'stable' && matrix.os == 'ubuntu-latest'
      uses: codecov/codecov-action@v4
      with:
        file: ./cobertura.xml
        flags: rust
        name: rust-coverage
        fail_ci_if_error: false

  # Cargo deny check (license/security)
  cargo-deny:
    name: Cargo Deny Check
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: EmbarkStudios/cargo-deny-action@v2
      with:
        log-level: warn
        command: check
        arguments: --all-features

  # Python SDK checks and tests
  python-sdk-check:
    name: Python SDK on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    needs: [rust-check]
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ['3.10', '3.11', '3.12']
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
    
    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-python-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-python-
    
    - name: Install system dependencies (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y libgl1-mesa-dev libglu1-mesa-dev libxrandr-dev libxinerama-dev libxcursor-dev libxi-dev libxxf86vm-dev libasound2-dev
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Build native library
      run: cargo build --release
    
    - name: Set up library path (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: echo "LD_LIBRARY_PATH=${{ github.workspace }}/target/release:$LD_LIBRARY_PATH" >> $GITHUB_ENV
    
    - name: Set up library path (macOS)
      if: matrix.os == 'macos-latest'
      run: echo "DYLD_LIBRARY_PATH=${{ github.workspace }}/target/release:$DYLD_LIBRARY_PATH" >> $GITHUB_ENV
    
    - name: Run Python SDK tests
      env:
        PYTHONPATH: ${{ github.workspace }}/sdks/python
      run: |
        python --version
        # Run Python tests that don't require a window/display
        # The test_game test requires windowed context which won't work in CI
        python << 'EOF'
        import sys
        sys.path.insert(0, 'sdks/python')
        from test_bindings import (
            test_imports, test_vec2, test_color, test_rect,
            test_transform2d, test_sprite, test_context, test_context_manager
        )
        tests = [
            test_imports, test_vec2, test_color, test_rect,
            test_transform2d, test_sprite, test_context, test_context_manager
        ]
        passed = 0
        failed = 0
        for test in tests:
            try:
                if test():
                    passed += 1
                else:
                    failed += 1
            except Exception as e:
                print(f'  x {test.__name__} failed: {e}')
                failed += 1
        print(f'Python SDK tests: {passed} passed, {failed} failed')
        sys.exit(1 if failed > 0 else 0)
        EOF
    
    - name: Test Python demo imports
      env:
        PYTHONPATH: ${{ github.workspace }}/sdks/python
      run: |
        cd examples/python
        python << 'EOF'
        import sys
        sys.path.insert(0, '../../sdks/python')
        from goud_engine import (
            GoudContext, Transform2D, Sprite, Vec2, Color
        )
        print('Python SDK imports successful')
        # Basic component tests
        t = Transform2D.from_position(100, 200)
        print(f'Transform2D: {t}')
        s = Sprite(texture_handle=42).with_color(1.0, 0.0, 0.0, 1.0)
        print(f'Sprite: {s}')
        ctx = GoudContext.create()
        print(f'Context created')
        e = ctx.spawn_entity()
        print(f'Entity spawned: {e}')
        ctx.destroy()
        print('All Python SDK basic tests passed!')
        EOF

  # .NET SDK checks and tests
  dotnet-check:
    name: .NET SDK on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    needs: [rust-check]
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
    - uses: actions/checkout@v4

    - name: Download generated C# bindings
      uses: actions/download-artifact@v4
      with:
        name: csharp-bindings
        path: sdks/GoudEngine

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: Cache cargo registry
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-dotnet-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-dotnet-
          ${{ runner.os }}-cargo-

    - name: Install system dependencies (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y libgl1-mesa-dev libglu1-mesa-dev libxrandr-dev libxinerama-dev libxcursor-dev libxi-dev libxxf86vm-dev libasound2-dev

    - name: Build native library
      run: cargo build --release

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Set up library path (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: echo "LD_LIBRARY_PATH=${{ github.workspace }}/target/release:$LD_LIBRARY_PATH" >> $GITHUB_ENV

    - name: Set up library path (macOS)
      if: matrix.os == 'macos-latest'
      run: echo "DYLD_LIBRARY_PATH=${{ github.workspace }}/target/release:$DYLD_LIBRARY_PATH" >> $GITHUB_ENV

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Restore dependencies
      working-directory: sdks/GoudEngine
      run: dotnet restore ../GoudEngine.Tests/GoudEngine.Tests.csproj

    - name: Build
      working-directory: sdks/GoudEngine
      run: dotnet build ../GoudEngine.Tests/GoudEngine.Tests.csproj --no-restore --configuration Release

    - name: Copy native library to test directory (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: cp target/release/libgoud_engine.so sdks/GoudEngine.Tests/bin/Release/net8.0/

    - name: Copy native library to test directory (macOS)
      if: matrix.os == 'macos-latest'
      run: cp target/release/libgoud_engine.dylib sdks/GoudEngine.Tests/bin/Release/net8.0/

    - name: Copy native library to test directory (Windows)
      if: matrix.os == 'windows-latest'
      run: copy target\release\goud_engine.dll sdks\GoudEngine.Tests\bin\Release\net8.0\libgoud_engine.dll

    - name: Test
      working-directory: sdks/GoudEngine
      run: dotnet test ../GoudEngine.Tests/GoudEngine.Tests.csproj --no-build --configuration Release --verbosity normal --logger "trx;LogFileName=test-results.trx"

    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: dotnet-test-results-${{ matrix.os }}
        path: '**/test-results.trx'

  # Build check to ensure everything compiles together
  integration-build:
    name: Integration Build Check
    runs-on: ${{ matrix.os }}
    needs: [rust-check, dotnet-check, python-sdk-check]
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install system dependencies (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y libgl1-mesa-dev libglu1-mesa-dev libxrandr-dev libxinerama-dev libxcursor-dev libxi-dev libxxf86vm-dev libasound2-dev

    - name: Run full build script
      run: |
        chmod +x build.sh
        ./build.sh --local
    
    - name: Verify build artifacts
      run: |
        # Check Rust library exists
        if [[ "$RUNNER_OS" == "macOS" ]]; then
          test -f sdks/GoudEngine/runtimes/osx-x64/native/libgoud_engine.dylib
        elif [[ "$RUNNER_OS" == "Linux" ]]; then
          test -f sdks/GoudEngine/runtimes/linux-x64/native/libgoud_engine.so
        fi
        
        # Check .NET package exists
        test -f sdks/nuget_package_output/GoudEngine.*.nupkg
    
    - name: Verify Python SDK can import
      env:
        PYTHONPATH: ${{ github.workspace }}/sdks/python
        LD_LIBRARY_PATH: ${{ github.workspace }}/target/debug:${{ env.LD_LIBRARY_PATH }}
        DYLD_LIBRARY_PATH: ${{ github.workspace }}/target/debug:${{ env.DYLD_LIBRARY_PATH }}
      run: |
        python -c "from goud_engine import GoudContext, Transform2D, Sprite; print('âœ“ Python SDK integration check passed')"

  # Final status check
  ci-success:
    name: CI Success
    if: always()
    needs: [rust-check, cargo-deny, dotnet-check, python-sdk-check, integration-build]
    runs-on: ubuntu-latest
    steps:
    - name: Check all jobs
      run: |
        if [[ "${{ needs.rust-check.result }}" != "success" ]] || \
           [[ "${{ needs.cargo-deny.result }}" != "success" ]] || \
           [[ "${{ needs.dotnet-check.result }}" != "success" ]] || \
           [[ "${{ needs.python-sdk-check.result }}" != "success" ]] || \
           [[ "${{ needs.integration-build.result }}" != "success" ]]; then
          echo "One or more jobs failed"
          exit 1
        fi
        echo "All checks passed!"